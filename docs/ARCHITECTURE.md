# Architecture Map

> Auto-generated by cartographer skill
> Last updated: 2026-01-18 05:50
> Project: GestioNeo | Type: Full-Stack (Node.js + React) | Version: 1.0.0

## Quick Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GESTIONEO                                          │
│            Sistema de Gestion para Local de Hamburguesas                     │
│                     (POS + Inventory + Payroll)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         FRONTEND                                     │   │
│   │                   React + Vite + Tailwind v4                         │   │
│   │                     http://localhost:5173                            │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│   │   │   ADMIN    │ │    MOZO    │ │  COCINERO  │ │  DELIVERY  │       │   │
│   │   │ /dashboard │ │/mozo/mesas │ │  /cocina   │ │ /delivery/ │       │   │
│   │   │ /empleados │ │  /pedidos  │ │            │ │  pedidos   │       │   │
│   │   │ /productos │ │            │ └────────────┘ └────────────┘       │   │
│   │   │ /reportes  │ └────────────┘                                     │   │
│   │   │ /stock     │                ┌────────────┐                      │   │
│   │   └────────────┘                │   PUBLIC   │                      │   │
│   │                                 │   /menu    │ (QR/Web)             │   │
│   │                                 └────────────┘                      │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                           │
│                                  │ axios (HTTP + JWT)                        │
│                                  ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          BACKEND                                     │   │
│   │                Node.js + Express + Prisma                            │   │
│   │                    http://localhost:3001                             │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │   │
│   │   │   app.js   │───▶│  Middleware │───▶│        Routes           │ │   │
│   │   │  (entry)   │    │  (JWT Auth) │    │  /api/auth              │ │   │
│   │   └────────────┘    │  (Roles)    │    │  /api/pedidos           │ │   │
│   │                     └─────────────┘    │  /api/pedidos/delivery  │ │   │
│   │                                        │  /api/productos         │ │   │
│   │                                        │  /api/empleados         │ │   │
│   │                                        │  /api/ingredientes      │ │   │
│   │                                        │  /api/liquidaciones     │ │   │
│   │                                        │  /api/impresion         │ │   │
│   │                                        └───────────┬─────────────┘ │   │
│   │                                                    │               │   │
│   │                                                    ▼               │   │
│   │                                        ┌─────────────────────────┐ │   │
│   │                                        │      Controllers        │ │   │
│   │                                        │   (Business Logic)      │ │   │
│   │                                        └───────────┬─────────────┘ │   │
│   │                                                    │               │   │
│   │                     ┌──────────────────────────────┼──────────┐   │   │
│   │                     ▼                              ▼          ▼   │   │
│   │             ┌─────────────┐              ┌──────────┐  ┌────────┐│   │
│   │             │   Prisma    │              │  ESC/POS │  │MercadoP││   │
│   │             │    ORM      │              │ Impresora│  │  ago   ││   │
│   │             └──────┬──────┘              └──────────┘  └────────┘│   │
│   │                    │                                             │   │
│   └────────────────────┼─────────────────────────────────────────────┘   │
│                        │                                                  │
│                        ▼                                                  │
│              ┌──────────────────┐                                         │
│              │    PostgreSQL    │                                         │
│              │    (Database)    │                                         │
│              └──────────────────┘                                         │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Directory Structure

```
GestioNeo/
├── backend/
│   ├── prisma/
│   │   ├── schema.prisma        # Database models & relations
│   │   ├── seed.js              # Initial data (users, products, etc.)
│   │   └── migrations/          # Prisma migrations
│   ├── src/
│   │   ├── app.js               # Express entry point
│   │   ├── controllers/         # Request handlers
│   │   │   ├── auth.controller.js
│   │   │   ├── pedidos.controller.js
│   │   │   ├── productos.controller.js
│   │   │   ├── mesas.controller.js
│   │   │   ├── categorias.controller.js
│   │   │   ├── empleados.controller.js
│   │   │   ├── ingredientes.controller.js
│   │   │   ├── fichajes.controller.js
│   │   │   ├── liquidaciones.controller.js
│   │   │   ├── reportes.controller.js
│   │   │   ├── pagos.controller.js
│   │   │   └── impresion.controller.js
│   │   ├── routes/              # API route definitions
│   │   │   └── *.routes.js
│   │   ├── middlewares/
│   │   │   └── auth.middleware.js  # JWT + verificarRol + esAdmin/esMozo/esDelivery
│   │   ├── services/            # (placeholder)
│   │   └── utils/               # (placeholder)
│   ├── uploads/                 # Product images
│   ├── package.json
│   └── .env
├── frontend/
│   ├── src/
│   │   ├── main.jsx             # React entry point
│   │   ├── App.jsx              # Router + ProtectedRoute
│   │   ├── index.css            # Tailwind v4 (@import + @theme)
│   │   ├── context/
│   │   │   └── AuthContext.jsx  # Auth state + role flags
│   │   ├── services/
│   │   │   └── api.js           # Axios instance
│   │   ├── components/
│   │   │   ├── layouts/
│   │   │   │   ├── AdminLayout.jsx   # Sidebar by role
│   │   │   │   └── PublicLayout.jsx
│   │   │   └── RedirectByRole.jsx    # Smart role-based redirect
│   │   ├── pages/
│   │   │   ├── Login.jsx
│   │   │   ├── MenuPublico.jsx       # QR/Web menu
│   │   │   ├── admin/
│   │   │   │   ├── Dashboard.jsx
│   │   │   │   ├── Empleados.jsx
│   │   │   │   ├── Mesas.jsx
│   │   │   │   ├── Categorias.jsx
│   │   │   │   ├── Productos.jsx
│   │   │   │   ├── Ingredientes.jsx
│   │   │   │   ├── Liquidaciones.jsx
│   │   │   │   ├── Reportes.jsx
│   │   │   │   └── Pedidos.jsx
│   │   │   ├── mozo/
│   │   │   │   ├── MozoMesas.jsx     # Table grid view
│   │   │   │   └── NuevoPedido.jsx   # Order creation
│   │   │   ├── cocina/
│   │   │   │   └── Cocina.jsx        # Kitchen display
│   │   │   └── delivery/
│   │   │       └── DeliveryPedidos.jsx  # Delivery orders view
│   │   └── hooks/               # (placeholder)
│   ├── public/
│   ├── postcss.config.js        # @tailwindcss/postcss
│   ├── vite.config.js
│   └── package.json
└── docs/
    └── ARCHITECTURE.md          # This file
```

## Entry Points

| File | Purpose | Invocation |
|------|---------|------------|
| `backend/src/app.js` | Express API server | `npm run dev` |
| `frontend/src/main.jsx` | React application | `npm run dev` |
| `backend/prisma/seed.js` | Database seeding | `npm run db:seed` |

## API Endpoints

```
┌───────────────────────────────────────────────────────────────────────────┐
│                             REST API                                       │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  Authentication                                                            │
│  ├── POST   /api/auth/login          # Login, returns JWT                 │
│  ├── POST   /api/auth/registrar      # Register (admin only)              │
│  └── GET    /api/auth/perfil         # Get current user                   │
│                                                                            │
│  Pedidos (Orders)                                                          │
│  ├── GET    /api/pedidos             # List orders                        │
│  ├── GET    /api/pedidos/cocina      # Kitchen view (pending orders)      │
│  ├── POST   /api/pedidos             # Create order                       │
│  ├── PATCH  /api/pedidos/:id/estado  # Update order status               │
│  └── POST   /api/pedidos/:id/items   # Add items to order                │
│                                                                            │
│  Productos & Categorías                                                    │
│  ├── GET    /api/categorias/publicas # Public menu (no auth)             │
│  ├── CRUD   /api/categorias          # Category management               │
│  └── CRUD   /api/productos           # Product management                │
│                                                                            │
│  Inventario                                                                │
│  ├── CRUD   /api/ingredientes        # Ingredients management            │
│  ├── GET    /api/ingredientes/alertas # Low stock alerts                 │
│  └── POST   /api/ingredientes/:id/movimiento  # Stock movements          │
│                                                                            │
│  Empleados & Sueldos                                                       │
│  ├── CRUD   /api/empleados           # Employee management               │
│  ├── POST   /api/fichajes/entrada    # Clock in                          │
│  ├── POST   /api/fichajes/salida     # Clock out                         │
│  ├── POST   /api/liquidaciones/calcular  # Calculate payroll             │
│  └── POST   /api/liquidaciones       # Create payroll record             │
│                                                                            │
│  Pagos & Reportes                                                          │
│  ├── POST   /api/pagos               # Register payment                  │
│  ├── POST   /api/pagos/webhook/mercadopago  # MP webhook (public)        │
│  └── GET    /api/reportes/*          # Sales, inventory reports          │
│                                                                            │
│  Impresión                                                                 │
│  ├── POST   /api/impresion/comanda/:id  # Print ticket (3 copies)        │
│  └── GET    /api/impresion/comanda/:id/preview  # Preview ticket         │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
```

## Database Schema

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PostgreSQL Database                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐                    ┌──────────────┐                      │
│   │   Usuario    │                    │   Empleado   │                      │
│   │──────────────│                    │──────────────│                      │
│   │ id           │                    │ id           │                      │
│   │ email        │                    │ nombre       │                      │
│   │ password     │                    │ dni          │                      │
│   │ nombre       │                    │ rol          │                      │
│   │ rol          │                    │ tarifaHora   │                      │
│   └──────┬───────┘                    └──────┬───────┘                      │
│          │                                   │                               │
│          │ 1:N                               │ 1:N                           │
│          ▼                                   ▼                               │
│   ┌──────────────┐                    ┌──────────────┐   ┌──────────────┐  │
│   │    Pedido    │                    │   Fichaje    │   │ Liquidacion  │  │
│   │──────────────│                    │──────────────│   │──────────────│  │
│   │ id           │                    │ entrada      │   │ horasTotales │  │
│   │ tipo         │◀───────────────────│ salida       │   │ totalPagar   │  │
│   │ estado       │         N:1        │ fecha        │   │ pagado       │  │
│   │ total        │                    └──────────────┘   └──────────────┘  │
│   │ mesaId?      │                                                          │
│   └──────┬───────┘                                                          │
│          │                                                                   │
│          │ 1:N                                                               │
│          ▼                                                                   │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐             │
│   │  PedidoItem  │      │   Producto   │      │  Categoria   │             │
│   │──────────────│      │──────────────│      │──────────────│             │
│   │ cantidad     │─────▶│ nombre       │─────▶│ nombre       │             │
│   │ observaciones│  N:1 │ precio       │  N:1 │ orden        │             │
│   │ precioUnit   │      │ disponible   │      └──────────────┘             │
│   └──────────────┘      └──────┬───────┘                                   │
│                                │                                            │
│                                │ N:M                                        │
│                                ▼                                            │
│                         ┌──────────────┐      ┌──────────────┐             │
│                         │  Producto    │      │ Ingrediente  │             │
│                         │ Ingrediente  │─────▶│──────────────│             │
│                         │──────────────│  N:1 │ stockActual  │             │
│                         │ cantidad     │      │ stockMinimo  │             │
│                         └──────────────┘      └──────┬───────┘             │
│                                                      │                      │
│   ┌──────────────┐      ┌──────────────┐            │ 1:N                  │
│   │     Mesa     │      │     Pago     │            ▼                      │
│   │──────────────│      │──────────────│     ┌──────────────┐             │
│   │ numero       │      │ monto        │     │ Movimiento   │             │
│   │ zona         │      │ metodo       │     │    Stock     │             │
│   │ estado       │      │ referencia   │     │──────────────│             │
│   │ capacidad    │      └──────────────┘     │ tipo         │             │
│   └──────────────┘                           │ cantidad     │             │
│                                              │ motivo       │             │
│                                              └──────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow

### Order Creation Flow

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   Mozo   │───▶│  Carrito │───▶│   API    │───▶│  Prisma  │───▶│    DB    │
│  (React) │    │  (state) │    │  /pedido │    │  create  │    │ (Pedido) │
└──────────┘    └──────────┘    └────┬─────┘    └──────────┘    └──────────┘
                                     │
                                     ▼
                               ┌──────────┐    ┌──────────┐
                               │Impresion │───▶│ ESC/POS  │ × 3 copias
                               │Controller│    │ Printer  │ (cocina/caja/cliente)
                               └──────────┘    └──────────┘
```

### Order Status Flow

```
PENDIENTE ──▶ EN_PREPARACION ──▶ LISTO ──▶ ENTREGADO ──▶ COBRADO
    │                                                        │
    └────────────────────── CANCELADO ◀──────────────────────┘
```

### Stock Deduction Flow

```
Pedido.estado = EN_PREPARACION
         │
         ▼
┌─────────────────────────┐
│ For each PedidoItem:    │
│   For each Ingrediente: │
│     - Decrement stock   │
│     - Create Movimiento │
└─────────────────────────┘
```

## User Roles & Permissions

```
┌───────────┬───────────┬────────────────────┬───────────┬───────────┬───────────┐
│   Role    │ Dashboard │      Pedidos       │ Inventar  │ Empleados │ Reportes  │
├───────────┼───────────┼────────────────────┼───────────┼───────────┼───────────┤
│   ADMIN   │     ✓     │ Todo               │     ✓     │     ✓     │     ✓     │
│   MOZO    │     -     │ Crear + ENTREGADO  │     -     │     -     │     -     │
│  COCINERO │     ✓     │ Cocina (estados)   │     -     │     -     │     -     │
│   CAJERO  │     ✓     │ Cobrar + estados   │     -     │     -     │     ✓     │
│  DELIVERY │     -     │ Solo delivery      │     -     │     -     │     -     │
└───────────┴───────────┴────────────────────┴───────────┴───────────┴───────────┘

Detalle de permisos MOZO:
- NO ve Dashboard
- Puede crear pedidos
- Solo puede cambiar estado a ENTREGADO (cuando entrega a mesa)
- NO puede registrar pagos
- NO puede cambiar a EN_PREPARACION ni LISTO

Detalle de permisos DELIVERY:
- Solo ve /delivery/pedidos
- Solo ve pedidos tipo DELIVERY
- Solo puede marcar como ENTREGADO
```

## Role-Based Redirects

```
Login exitoso:
  ├── ADMIN    ──▶ /dashboard
  ├── MOZO     ──▶ /mozo/mesas
  ├── COCINERO ──▶ /cocina
  ├── CAJERO   ──▶ /dashboard
  └── DELIVERY ──▶ /delivery/pedidos
```

## Key Files

| File | Responsibility | Read Before |
|------|----------------|-------------|
| `backend/prisma/schema.prisma` | Database models | Any DB changes |
| `backend/src/middlewares/auth.middleware.js` | JWT + Role verification | Auth changes |
| `backend/src/controllers/pedidos.controller.js` | Order logic | Order flow changes |
| `frontend/src/context/AuthContext.jsx` | Global auth state | Auth UI changes |
| `frontend/src/App.jsx` | Route definitions | Adding pages |

## External Dependencies

| Service | Purpose | Config Location |
|---------|---------|-----------------|
| PostgreSQL | Primary database | `DATABASE_URL` in `.env` |
| MercadoPago | Payment processing | `MERCADOPAGO_ACCESS_TOKEN` |
| ESC/POS Printer | Thermal printing | USB connection |

## Environment Variables

```bash
# Backend (.env)
PORT=3001
DATABASE_URL="postgresql://user:pass@localhost:5432/gestioneo"
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="24h"
MERCADOPAGO_ACCESS_TOKEN="TEST-xxx"
FRONTEND_URL="http://localhost:5173"
```

## Notes for Agents

### Conventions
- Backend: CommonJS modules (`require`/`module.exports`)
- Frontend: ES Modules (`import`/`export`)
- API responses: `{ data }` or `{ error: { message } }`
- Dates: ISO 8601 format
- Money: Decimal with 2 places (Prisma `Decimal(10,2)`)

### Gotchas
- Stock deduction happens on `EN_PREPARACION`, not on order creation
- Mesa status changes automatically with order states
- Public routes (`/menu`, `/categorias/publicas`) don't require auth
- Webhook endpoint `/api/pagos/webhook/mercadopago` is public
- **MOZO solo puede cambiar estado a ENTREGADO** (validado en backend)
- **MOZO no ve boton de pago** (ocultado en frontend)
- Tailwind v4 usa `@import "tailwindcss"` y `@theme` en index.css
- No hay tailwind.config.js - usa postcss.config.js con @tailwindcss/postcss

### Warnings
- `JWT_SECRET` must be changed in production
- Image uploads go to `backend/uploads/` - not persisted in containers
- Printer integration requires local USB connection

### Testing
```bash
# Backend
cd backend
npm run dev                    # Start API on :3001
npm run db:seed               # Reset test data

# Frontend
cd frontend
npm run dev                    # Start React on :5173

# Test users
admin@gestioneo.com / admin123
mozo@gestioneo.com / mozo123
cocinero@gestioneo.com / cocinero123
```
