# Architecture Map

> Auto-generated by cartographer skill
> Last updated: 2026-01-23 15:24
> Project: GestioNeo | Type: Full-Stack (Node.js + React) | Version: 1.0.0

## Quick Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GESTIONEO                                          │
│            Sistema de Gestión para Restaurante / Local Gastronómico          │
│                     (POS + Inventory + Payroll + Events)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         FRONTEND                                     │   │
│   │                   React 19 + Vite + Tailwind v4                      │   │
│   │                     http://localhost:5173                            │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│   │   │   ADMIN    │ │    MOZO    │ │  COCINA    │ │  DELIVERY  │       │   │
│   │   │ /dashboard │ │/mozo/mesas │ │  /cocina   │ │ /delivery/ │       │   │
│   │   │ /mesas     │ │/mozo/nuevo │ │            │ │  pedidos   │       │   │
│   │   │ /productos │ │  pedido    │ └────────────┘ └────────────┘       │   │
│   │   │ /modific   │ └────────────┘  ┌────────────┐                     │   │
│   │   │ /reservas  │                 │   PUBLIC   │                     │   │
│   │   │ /reportes  │                 │ /menu/:slug│ (QR/Web)            │   │
│   │   │ /cierre    │                 └────────────┘                     │   │
│   │   │ /config    │  ┌────────────┐                                   │   │
│   │   │ /trans-mp  │  │    AUTH    │                                   │   │
│   │   │ /pedidos   │  │ /registro  │                                   │   │
│   │   │ + más      │  │ /verificar │                                   │   │
│   │   └────────────┘  │  email     │                                   │   │
│   │                   └────────────┘                                   │   │
│   │                                                                      │   │
│   │   ┌──────────────────────────────────────────────────────────────┐  │   │
│   │   │                 Event Source (SSE)                            │  │   │
│   │   │  Eventos: pedido.updated, mesa.updated, pago.updated,        │  │   │
│   │   │           impresion.updated, reserva.updated,                │  │   │
│   │   │           producto.agotado, producto.disponible              │  │   │
│   │   └──────────────────────────────────────────────────────────────┘  │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                           │
│                                  │ axios (HTTP + JWT) + SSE                  │
│                                  ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          BACKEND                                     │   │
│   │                Node.js + Express 5 + Prisma                          │   │
│   │                    http://localhost:3001                             │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │   │
│   │   │   app.js   │───▶│  Middleware │───▶│        Routes           │ │   │
│   │   │  (entry)   │    │  (JWT Auth) │    │  /api/auth              │ │   │
│   │   └────────────┘    │  (Roles)    │    │  /api/registro          │ │   │
│   │                     │  (Helmet)   │    │  /api/tenant            │ │   │
│   │                     │  (CORS)     │    │  /api/super-admin       │ │   │
│   │                     └─────────────┘    │  /api/pedidos           │ │   │
│   │                                        │  /api/mesas             │ │   │
│   │                                        │  /api/productos         │ │   │
│   │                                        │  /api/categorias        │ │   │
│   │                                        │  /api/modificadores     │ │   │
│   │                                        │  /api/reservas          │ │   │
│   │                                        │  /api/cierres           │ │   │
│   │                                        │  /api/empleados         │ │   │
│   │                                        │  /api/ingredientes      │ │   │
│   │                                        │  /api/liquidaciones     │ │   │
│   │                                        │  /api/reportes          │ │   │
│   │                                        │  /api/pagos             │ │   │
│   │                                        │  /api/mercadopago       │ │   │
│   │                                        │  /api/configuracion     │ │   │
│   │                                        │  /api/publico           │ │   │
│   │                                        │  /api/impresion         │ │   │
│   │                                        │  /api/eventos (SSE)     │ │   │
│   │                                        └───────────┬─────────────┘ │   │
│   │                                                    │               │   │
│   │                                                    ▼               │   │
│   │                                        ┌─────────────────────────┐ │   │
│   │                                        │      Controllers        │ │   │
│   │                                        │   (Business Logic)      │ │   │
│   │                                        └───────────┬─────────────┘ │   │
│   │                                                    │               │   │
│   │   ┌──────────────────────────────────────────────┬┼───────────┐   │   │
│   │   ▼                  ▼                ▼          ▼│           ▼   │   │
│   │ ┌───────┐    ┌─────────────┐   ┌──────────┐  ┌────────┐ ┌───────┐│   │
│   │ │Prisma │    │   Email     │   │MercadoPa │  │ Event  │ │Print  ││   │
│   │ │ ORM   │    │  Service    │   │   go     │  │  Bus   │ │Service││   │
│   │ └───┬───┘    │(Nodemailer) │   │  SDK v2  │  │ (SSE)  │ │(Queue)││   │
│   │     │        └─────────────┘   └──────────┘  └────────┘ └───────┘│   │
│   └─────┼─────────────────────────────────────────────────────────────┘   │
│         │                                                                  │
│         ▼                                                                  │
│   ┌──────────────────┐                    ┌──────────────────┐            │
│   │    PostgreSQL    │                    │   Print Bridge   │            │
│   │    (Database)    │                    │   (Windows PC)   │            │
│   │    + Supabase    │                    │  ESC/POS spooler │            │
│   └──────────────────┘                    └──────────────────┘            │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Multi-Tenancy

- Authenticated routes set tenant context from JWT (`setTenantFromAuth`), enforcing tenantId scoping in controllers/services.
- Public endpoints require slug (`/api/publico/:slug/...`) via `resolveTenantFromSlug` to resolve tenant config and menu.
- SSE (`/api/eventos`) filters events by `tenantId`; SUPER_ADMIN can see all tenants.
- Print bridge endpoints accept tenant slug headers (`setTenantFromSlugHeader`) for multi-tenant job claiming.

## Directory Structure

```
GestioNeo/
├── backend/
│   ├── prisma/
│   │   ├── schema.prisma           # Database models & relations
│   │   ├── seed.js                 # Base seed (generic users)
│   │   ├── seed-ewald.js           # Estación Ewald products (38 products)
│   │   ├── seed-test-data.js       # Test data (users, orders, stock, etc.)
│   │   ├── migrations/             # Prisma migrations
│   │   │   └── 20260202000000_baseline/
│   │   └── migrations_legacy/      # Legacy migrations archive
│   ├── src/
│   │   ├── server.js               # Backend server bootstrap
│   │   ├── app.js                  # Express entry point
│   │   ├── controllers/            # Request handlers
│   │   │   ├── auth.controller.js
│   │   │   ├── categorias.controller.js
│   │   │   ├── cierres.controller.js
│   │   │   ├── configuracion.controller.js
│   │   │   ├── empleados.controller.js
│   │   │   ├── fichajes.controller.js
│   │   │   ├── impresion.controller.js
│   │   │   ├── ingredientes.controller.js
│   │   │   ├── liquidaciones.controller.js
│   │   │   ├── mercadopago-oauth.controller.js
│   │   │   ├── mesas.controller.js
│   │   │   ├── modificadores.controller.js
│   │   │   ├── pagos.controller.js
│   │   │   ├── pedidos.controller.js
│   │   │   ├── productos.controller.js
│   │   │   ├── registro.controller.js
│   │   │   ├── reportes.controller.js
│   │   │   ├── reservas.controller.js
│   │   │   ├── superadmin.controller.js
│   │   │   └── tenant.controller.js
│   │   ├── routes/                 # API route definitions
│   │   │   ├── auth.routes.js
│   │   │   ├── categorias.routes.js
│   │   │   ├── cierres.routes.js
│   │   │   ├── configuracion.routes.js
│   │   │   ├── empleados.routes.js
│   │   │   ├── eventos.routes.js   # Server-Sent Events
│   │   │   ├── fichajes.routes.js
│   │   │   ├── impresion.routes.js
│   │   │   ├── ingredientes.routes.js
│   │   │   ├── liquidaciones.routes.js
│   │   │   ├── mercadopago.routes.js
│   │   │   ├── mesas.routes.js
│   │   │   ├── modificadores.routes.js
│   │   │   ├── pagos.routes.js
│   │   │   ├── pedidos.routes.js
│   │   │   ├── productos.routes.js
│   │   │   ├── publico.routes.js   # Public menu & orders
│   │   │   ├── registro.routes.js
│   │   │   ├── reportes.routes.js
│   │   │   ├── reservas.routes.js
│   │   │   ├── superadmin.routes.js
│   │   │   └── tenant.routes.js
│   │   ├── middlewares/
│   │   │   ├── auth.middleware.js  # JWT + roles
│   │   │   ├── error.middleware.js # Error formatter
│   │   │   ├── tenant.middleware.js # Tenant scoping
│   │   │   └── validate.middleware.js # Zod validation
│   │   ├── services/
│   │   │   ├── categorias.service.js
│   │   │   ├── cierres.service.js
│   │   │   ├── configuracion.service.js
│   │   │   ├── crypto.service.js
│   │   │   ├── email.service.js
│   │   │   ├── empleados.service.js
│   │   │   ├── event-bus.js
│   │   │   ├── fichajes.service.js
│   │   │   ├── impresion.service.js
│   │   │   ├── ingredientes.service.js
│   │   │   ├── liquidaciones.service.js
│   │   │   ├── mercadopago.service.js
│   │   │   ├── mercadopago-config.service.js
│   │   │   ├── mesas.service.js
│   │   │   ├── modificadores.service.js
│   │   │   ├── pagos.service.js
│   │   │   ├── pedidos.service.js
│   │   │   ├── print.service.js
│   │   │   ├── productos.service.js
│   │   │   ├── publico.service.js
│   │   │   ├── registro.service.js
│   │   │   ├── reportes.service.js
│   │   │   ├── reservas.service.js
│   │   │   ├── superadmin.service.js
│   │   │   └── tenant.service.js
│   │   ├── schemas/                # Zod schemas
│   │   ├── db/                     # Prisma client
│   │   ├── jobs/                   # Background jobs
│   │   └── utils/
│   ├── uploads/                    # Product images + banners
│   ├── package.json
│   ├── .env
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── main.jsx                # React entry point
│   │   ├── App.jsx                 # Router + ProtectedRoute
│   │   ├── index.css               # Tailwind v4 (@import + @theme)
│   │   ├── context/
│   │   │   └── AuthContext.jsx     # Auth state + role flags
│   │   ├── services/
│   │   │   ├── api.js              # Axios instance
│   │   │   └── eventos.js          # EventSource wrapper for SSE
│   │   ├── components/
│   │   │   ├── RedirectByRole.jsx  # Smart role-based redirect
│   │   │   ├── configuracion/
│   │   │   │   └── MercadoPagoConfig.jsx
│   │   │   ├── layouts/
│   │   │   │   ├── AdminLayout.jsx # Sidebar by role
│   │   │   │   └── PublicLayout.jsx
│   │   │   └── pedidos/
│   │   │       └── NuevoPedidoModal.jsx
│   │   ├── pages/
│   │   │   ├── Login.jsx
│   │   │   ├── Registro.jsx
│   │   │   ├── VerificarEmail.jsx
│   │   │   ├── MenuPublico.jsx     # QR/Web menu with ordering
│   │   │   ├── admin/
│   │   │   │   ├── Dashboard.jsx
│   │   │   │   ├── Empleados.jsx
│   │   │   │   ├── Mesas.jsx
│   │   │   │   ├── Categorias.jsx
│   │   │   │   ├── Productos.jsx
│   │   │   │   ├── Ingredientes.jsx
│   │   │   │   ├── Modificadores.jsx
│   │   │   │   ├── Reservas.jsx
│   │   │   │   ├── Liquidaciones.jsx
│   │   │   │   ├── Reportes.jsx    # Charts: donut, ranking
│   │   │   │   ├── CierreCaja.jsx
│   │   │   │   ├── TransaccionesMercadoPago.jsx
│   │   │   │   ├── Configuracion.jsx
│   │   │   │   └── Pedidos.jsx
│   │   │   ├── mozo/
│   │   │   │   ├── MozoMesas.jsx   # Table grid view
│   │   │   │   └── NuevoPedido.jsx # Order creation
│   │   │   ├── cocina/
│   │   │   │   └── Cocina.jsx      # Kitchen display
│   │   │   └── delivery/
│   │   │       └── DeliveryPedidos.jsx
│   │   ├── hooks/
│   │   │   ├── useAsync.js
│   │   │   ├── useDebouncedValue.js
│   │   │   ├── useEventSource.js
│   │   │   ├── usePedidoConModificadores.js
│   │   │   ├── usePolling.js
│   │   │   └── useTimeout.js
│   │   └── __tests__/
│   ├── public/
│   ├── postcss.config.js           # @tailwindcss/postcss
│   ├── vite.config.js
│   └── package.json
├── bridge/                          # Print Bridge for Windows
│   ├── index.js                    # Main polling service
│   └── README.md                   # Setup instructions
├── docs/
│   └── ARCHITECTURE.md             # This file
├── DEPLOY.md                       # Deployment guide (Supabase + Railway + Vercel)
└── README.md                       # Project overview
```

## Entry Points

| File | Purpose | Invocation |
|------|---------|------------|
| `backend/src/server.js` | Backend server bootstrap (listen + jobs) | `npm run dev` |
| `backend/src/app.js` | Express app (routes + middleware) | (imported by server/tests) |
| `frontend/src/main.jsx` | React application | `npm run dev` |
| `backend/prisma/seed.js` | Base database seeding | `npm run db:seed` |
| `backend/prisma/seed-ewald.js` | Load Estación Ewald products | `node prisma/seed-ewald.js` |
| `backend/prisma/seed-test-data.js` | Load test data | `node prisma/seed-test-data.js` |
| `bridge/index.js` | Print bridge service | `node index.js` |

## Module Dependencies

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              BACKEND                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────┐                                                               │
│   │server.js │ (entry point)                                                 │
│   └────┬─────┘                                                               │
│        │                                                                     │
│        ├──▶ app.js (Express app)                                             │
│        │                                                                     │
│        ├──▶ helmet (security headers)                                        │
│        ├──▶ cors (cross-origin)                                              │
│        ├──▶ express.json (body parsing)                                      │
│        │                                                                     │
│        ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           ROUTES                                     │   │
│   ├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤   │
│   │    auth     │   pedidos   │  productos  │ ingredientes│  fichajes   │   │
│   │   routes    │   routes    │   routes    │   routes    │   routes    │   │
│   └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘   │
│          │             │             │             │             │          │
│          ▼             ▼             ▼             ▼             ▼          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      AUTH MIDDLEWARE                                 │   │
│   │           verificarToken + verificarRol([roles])                    │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        CONTROLLERS                                   │   │
│   └──────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────────┘   │
│          │         │         │         │         │         │               │
│          ▼         ▼         ▼         ▼         ▼         ▼               │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│   │  Prisma  │ │  Event   │ │  Email   │ │  Print   │ │MercadoPa │        │
│   │  Client  │ │   Bus    │ │ Service  │ │ Service  │ │   go     │        │
│   └────┬─────┘ └────┬─────┘ └──────────┘ └────┬─────┘ └──────────┘        │
│        │            │                         │                            │
│        ▼            ▼                         ▼                            │
│   ┌──────────┐ ┌──────────┐            ┌──────────┐                       │
│   │PostgreSQL│ │   SSE    │            │Print Jobs│                       │
│   │    DB    │ │ Clients  │            │  Table   │                       │
│   └──────────┘ └──────────┘            └──────────┘                       │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API Endpoints

```
┌───────────────────────────────────────────────────────────────────────────┐
│                             REST API                                       │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  Authentication                                                            │
│  ├── POST   /api/auth/login                                            │
│  ├── POST   /api/auth/registrar                                        │
│  ├── GET    /api/auth/perfil                                           │
│  └── PUT    /api/auth/cambiar-password                                 │
│                                                                            │
│  Registro (Onboarding)                                                     │
│  ├── POST   /api/registro                                              │
│  ├── GET    /api/registro/verificar/:token                            │
│  ├── POST   /api/registro/reenviar                                     │
│  └── GET    /api/registro/slug/:slug                                   │
│                                                                            │
│  Tenant (Admin)                                                            │
│  ├── GET    /api/tenant                                                │
│  ├── PUT    /api/tenant                                                │
│  └── GET    /api/tenant/verificar-slug/:slug                           │
│                                                                            │
│  Super Admin                                                               │
│  ├── GET    /api/super-admin/tenants                                  │
│  ├── GET    /api/super-admin/tenants/:id                              │
│  ├── PATCH  /api/super-admin/tenants/:id/toggle                      │
│  ├── GET    /api/super-admin/tenants/:id/metricas                    │
│  └── GET    /api/super-admin/metricas                                │
│                                                                            │
│  Pedidos (Orders)                                                          │
│  ├── GET    /api/pedidos                                                 │
│  ├── GET    /api/pedidos/cocina                                          │
│  ├── GET    /api/pedidos/delivery                                        │
│  ├── GET    /api/pedidos/:id                                             │
│  ├── POST   /api/pedidos                                                 │
│  ├── PATCH  /api/pedidos/:id/estado                                      │
│  ├── POST   /api/pedidos/:id/items                                       │
│  └── POST   /api/pedidos/:id/cancelar                                    │
│                                                                            │
│  Mesas (Tables)                                                            │
│  ├── GET    /api/mesas                                                   │
│  ├── GET    /api/mesas/:id                                               │
│  ├── POST   /api/mesas                                                   │
│  ├── PUT    /api/mesas/:id                                               │
│  ├── PATCH  /api/mesas/:id/estado                                        │
│  └── DELETE /api/mesas/:id                                               │
│                                                                            │
│  Productos & Variantes                                                     │
│  ├── GET    /api/productos                                               │
│  ├── GET    /api/productos/con-variantes                                 │
│  ├── GET    /api/productos/:id                                           │
│  ├── POST   /api/productos                                               │
│  ├── PUT    /api/productos/:id                                           │
│  ├── PATCH  /api/productos/:id/disponibilidad                            │
│  ├── DELETE /api/productos/:id                                           │
│  ├── POST   /api/productos/:id/variantes                                 │
│  ├── PUT    /api/productos/:id/variante                                  │
│  ├── DELETE /api/productos/:id/desagrupar                                │
│  └── POST   /api/productos/agrupar-variantes                             │
│                                                                            │
│  Categorías                                                                │
│  ├── GET    /api/categorias                                              │
│  ├── GET    /api/categorias/publicas                                     │
│  ├── POST   /api/categorias                                              │
│  ├── PUT    /api/categorias/:id                                          │
│  └── DELETE /api/categorias/:id                                          │
│                                                                            │
│  Modificadores                                                             │
│  ├── GET    /api/modificadores                                           │
│  ├── GET    /api/modificadores/:id                                       │
│  ├── GET    /api/modificadores/producto/:productoId                      │
│  ├── POST   /api/modificadores                                           │
│  ├── PUT    /api/modificadores/:id                                       │
│  ├── DELETE /api/modificadores/:id                                       │
│  └── PUT    /api/modificadores/producto/:productoId                      │
│                                                                            │
│  Inventario                                                                │
│  ├── GET    /api/ingredientes                                            │
│  ├── GET    /api/ingredientes/alertas                                    │
│  ├── GET    /api/ingredientes/:id                                        │
│  ├── POST   /api/ingredientes                                            │
│  ├── PUT    /api/ingredientes/:id                                        │
│  ├── POST   /api/ingredientes/:id/movimiento                             │
│  └── POST   /api/ingredientes/:id/ajuste                                 │
│                                                                            │
│  Empleados & Sueldos                                                       │
│  ├── GET    /api/empleados                                               │
│  ├── GET    /api/empleados/:id                                           │
│  ├── POST   /api/empleados                                               │
│  ├── PUT    /api/empleados/:id                                           │
│  ├── DELETE /api/empleados/:id                                           │
│  ├── GET    /api/fichajes                                                │
│  ├── POST   /api/fichajes/entrada                                        │
│  ├── POST   /api/fichajes/salida                                         │
│  ├── GET    /api/fichajes/empleado/:empleadoId/estado                     │
│  ├── GET    /api/fichajes/empleado/:empleadoId/horas                      │
│  ├── PUT    /api/fichajes/:id                                             │
│  ├── GET    /api/liquidaciones                                            │
│  ├── GET    /api/liquidaciones/:id                                        │
│  ├── POST   /api/liquidaciones/calcular                                  │
│  ├── POST   /api/liquidaciones                                            │
│  ├── PATCH  /api/liquidaciones/:id/pagar                                  │
│  └── DELETE /api/liquidaciones/:id                                        │
│                                                                            │
│  Reservas                                                                  │
│  ├── GET    /api/reservas                                                 │
│  ├── GET    /api/reservas/proximas                                        │
│  ├── GET    /api/reservas/:id                                             │
│  ├── POST   /api/reservas                                                 │
│  ├── PUT    /api/reservas/:id                                             │
│  ├── PATCH  /api/reservas/:id/estado                                      │
│  └── DELETE /api/reservas/:id                                             │
│                                                                            │
│  Cierres de Caja                                                           │
│  ├── GET    /api/cierres/actual                                           │
│  ├── GET    /api/cierres/resumen                                          │
│  ├── GET    /api/cierres                                                  │
│  ├── POST   /api/cierres                                                  │
│  └── PATCH  /api/cierres/:id/cerrar                                       │
│                                                                            │
│  Pagos                                                                     │
│  ├── POST   /api/pagos                                                    │
│  ├── GET    /api/pagos/pedido/:pedidoId                                   │
│  ├── POST   /api/pagos/mercadopago/preferencia                            │
│  └── POST   /api/pagos/webhook/mercadopago                                │
│                                                                            │
│  MercadoPago OAuth/Config                                                  │
│  ├── GET    /api/mercadopago/oauth/callback                               │
│  ├── GET    /api/mercadopago/oauth/authorize                              │
│  ├── DELETE /api/mercadopago/oauth/disconnect                             │
│  ├── GET    /api/mercadopago/status                                       │
│  ├── POST   /api/mercadopago/config/manual                                │
│  └── GET    /api/mercadopago/transacciones                                │
│                                                                            │
│  Reportes                                                                  │
│  ├── GET    /api/reportes/dashboard                                       │
│  ├── GET    /api/reportes/ventas                                          │
│  ├── GET    /api/reportes/productos-mas-vendidos                          │
│  ├── GET    /api/reportes/ventas-por-mozo                                 │
│  ├── GET    /api/reportes/ventas-por-producto-base                        │
│  ├── GET    /api/reportes/consumo-insumos                                 │
│  ├── GET    /api/reportes/inventario                                      │
│  └── GET    /api/reportes/sueldos                                         │
│                                                                            │
│  Configuración                                                             │
│  ├── GET    /api/configuracion                                            │
│  ├── PUT    /api/configuracion/:clave                                     │
│  ├── PUT    /api/configuracion                                            │
│  └── POST   /api/configuracion/banner                                     │
│                                                                            │
│  Público (No auth required)                                                │
│  ├── GET    /api/publico/:slug/config                                     │
│  ├── GET    /api/publico/:slug/menu                                       │
│  ├── POST   /api/publico/:slug/pedido                                     │
│  ├── GET    /api/publico/:slug/pedido/:id                                 │
│  ├── POST   /api/publico/:slug/pedido/:id/pagar                           │
│  └── (deprecated) /api/publico/config, /api/publico/menu                  │
│                                                                            │
│  Impresión                                                                 │
│  ├── POST   /api/impresion/comanda/:pedidoId                              │
│  ├── GET    /api/impresion/comanda/:pedidoId/preview                      │
│  ├── POST   /api/impresion/comanda/:pedidoId/reimprimir                   │
│  ├── GET    /api/impresion/estado                                         │
│  ├── POST   /api/impresion/jobs/claim                                     │
│  ├── POST   /api/impresion/jobs/:id/ack                                   │
│  └── POST   /api/impresion/jobs/:id/fail                                  │
│                                                                            │
│  Eventos (Server-Sent Events)                                              │
│  └── GET    /api/eventos                                                  │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
```

## Database Schema

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PostgreSQL Database                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐                    ┌──────────────┐                      │
│   │   Usuario    │                    │   Empleado   │                      │
│   │──────────────│                    │──────────────│                      │
│   │ id           │                    │ id           │                      │
│   │ email        │                    │ nombre       │                      │
│   │ password     │                    │ dni          │                      │
│   │ nombre       │                    │ rol          │                      │
│   │ rol          │                    │ tarifaHora   │                      │
│   │ activo       │                    │ activo       │                      │
│   └──────┬───────┘                    └──────┬───────┘                      │
│          │                                   │                               │
│          │ 1:N                               │ 1:N                           │
│          ▼                                   ├───────────────┐               │
│   ┌──────────────┐                    ┌──────┴─────┐   ┌─────┴────────┐     │
│   │    Pedido    │                    │  Fichaje   │   │ Liquidacion  │     │
│   │──────────────│                    │────────────│   │──────────────│     │
│   │ id           │                    │ entrada    │   │ horasTotales │     │
│   │ tipo         │ (MESA/DELIVERY/    │ salida     │   │ totalPagar   │     │
│   │ estado       │  MOSTRADOR)        │ fecha      │   │ pagado       │     │
│   │ estadoPago   │                    └────────────┘   └──────────────┘     │
│   │ origen       │ (INTERNO/MENU_PUBLICO)                                   │
│   │ total        │                                                          │
│   │ mesaId?      │──────────┐                                               │
│   │ clienteEmail?│          │                                               │
│   │ impreso      │          │ N:1                                           │
│   └──────┬───────┘          │                                               │
│          │                  ▼                                               │
│          │           ┌──────────────┐                                       │
│          │           │     Mesa     │                                       │
│          │           │──────────────│                                       │
│          │           │ numero       │                                       │
│          │           │ zona         │                                       │
│          │           │ estado       │ (LIBRE/OCUPADA/RESERVADA)             │
│          │           │ capacidad    │                                       │
│          │           └──────────────┘                                       │
│          │                                                                   │
│          │ 1:N                                                               │
│          ├───────────────┬───────────────┐                                  │
│          ▼               ▼               ▼                                  │
│   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                       │
│   │  PedidoItem  │ │     Pago     │ │   PrintJob   │                       │
│   │──────────────│ │──────────────│ │──────────────│                       │
│   │ cantidad     │ │ monto        │ │ tipo         │ (COCINA/CAJA/CLIENTE) │
│   │ observaciones│ │ metodo       │ │ status       │                       │
│   │ precioUnit   │ │ estado       │ │ contenido    │                       │
│   │ subtotal     │ │ mpPaymentId  │ │ intentos     │                       │
│   └──────┬───────┘ │ idempotency  │ │ batchId      │                       │
│          │         └──────────────┘ └──────────────┘                       │
│          │ N:1                                                              │
│          ▼                                                                  │
│   ┌──────────────┐                                                          │
│   │   Producto   │                                                          │
│   │──────────────│                                                          │
│   │ nombre       │                                                          │
│   │ precio       │───────────────┐                                          │
│   │ disponible   │    N:1        │                                          │
│   │ destacado    │               ▼                                          │
│   │ imagen       │        ┌──────────────┐                                  │
│   └──────┬───────┘        │  Categoria   │                                  │
│          │                │──────────────│                                  │
│          │ N:M            │ nombre       │                                  │
│          ▼                │ orden        │                                  │
│   ┌──────────────┐        └──────────────┘                                  │
│   │  Producto    │                                                          │
│   │ Ingrediente  │        ┌──────────────┐                                  │
│   │──────────────│        │ Ingrediente  │                                  │
│   │ cantidad     │───────▶│──────────────│                                  │
│   └──────────────┘   N:1  │ stockActual  │                                  │
│                           │ stockMinimo  │                                  │
│                           │ unidad       │                                  │
│                           │ costo        │                                  │
│                           └──────┬───────┘                                  │
│                                  │                                          │
│                                  │ 1:N                                      │
│                                  ▼                                          │
│                           ┌──────────────┐                                  │
│                           │ Movimiento   │                                  │
│                           │    Stock     │                                  │
│                           │──────────────│                                  │
│                           │ tipo         │ (ENTRADA/SALIDA/AJUSTE)          │
│                           │ cantidad     │                                  │
│                           │ motivo       │                                  │
│                           │ pedidoId?    │                                  │
│                           └──────────────┘                                  │
│                                                                              │
│   ┌──────────────┐                                                          │
│   │Configuracion │  (clave/valor store for system settings)                │
│   │──────────────│                                                          │
│   │ clave        │  tienda_abierta, costo_delivery, nombre_local,          │
│   │ valor        │  telefono, direccion, mercadopago_enabled, banner_url   │
│   └──────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

Notas del esquema:
- Multi-tenant: la mayoría de tablas incluyen `tenantId`; `Usuario.tenantId` puede ser `NULL` para `SUPER_ADMIN`.
- Nuevas entidades clave: `Tenant`, `EmailVerificacion`, `Reserva`, `Modificador`/`ProductoModificador`, `PedidoItemModificador`,
  `CierreCaja`, `MercadoPagoConfig`, `TransaccionMercadoPago`, `PrintJob`.

## Data Flow

### Order Creation Flow (Internal - Mozo)

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   Mozo   │───▶│  Carrito │───▶│   API    │───▶│  Prisma  │───▶│    DB    │
│  (React) │    │  (state) │    │  /pedido │    │  create  │    │ (Pedido) │
└──────────┘    └──────────┘    └────┬─────┘    └──────────┘    └──────────┘
                                     │
                                     ├────▶ EventBus.publish('pedido.updated')
                                     │              │
                                     │              ▼
                                     │       ┌──────────┐
                                     │       │   SSE    │ ──▶ Cocina UI auto-refresh
                                     │       │ Clients  │
                                     │       └──────────┘
                                     │
                                     ▼ (on estado = EN_PREPARACION)
                               ┌──────────┐
                               │PrintServ │───▶ PrintJob × 3
                               │ .enqueue │     (COCINA/CAJA/CLIENTE)
                               └──────────┘
                                     │
                                     ▼
                               ┌──────────┐    ┌──────────┐
                               │Print Poll│───▶│ ESC/POS  │
                               │ (Bridge) │    │ Printer  │
                               └──────────┘    └──────────┘
```

### Public Order Flow (Menu QR)

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ Customer │───▶│ /menu    │───▶│ /publico │───▶│  Pedido  │
│  (Phone) │    │  (React) │    │  /pedido │    │ origen=  │
└──────────┘    └────┬─────┘    └────┬─────┘    │MENU_PUBL │
                     │               │          └────┬─────┘
                     ▼               ▼               │
              ┌──────────┐    ┌──────────┐          │
              │MercadoPa │◀───│ /pagar   │          │
              │   go     │    │ endpoint │          │
              └────┬─────┘    └──────────┘          │
                   │                                 │
                   ▼                                 ▼
              ┌──────────┐                    ┌──────────┐
              │ Webhook  │───────────────────▶│  Pago    │
              │ callback │   verify + save    │ APROBADO │
              └──────────┘                    └──────────┘
                                                    │
                                                    ▼
                                              ┌──────────┐
                                              │  Email   │
                                              │ Service  │ (confirmation)
                                              └──────────┘
```

### Order Status Flow

```
PENDIENTE ──▶ EN_PREPARACION ──▶ LISTO ──▶ ENTREGADO ──▶ COBRADO
    │              │                                        │
    │              │ (descuenta stock)                      │ (libera mesa)
    │              │ (encola impresion)                     │
    │              │                                        │
    └──────────────┴────────── CANCELADO ◀──────────────────┘
                                   │
                                   │ (revierte stock si descontó)
                                   │ (libera mesa)
```

### Real-Time Events (SSE)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              EVENT BUS                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Events Published:                                                          │
│   ├── pedido.updated    { id, estado, tipo, mesaId, updatedAt }             │
│   ├── mesa.updated      { mesaId, estado, updatedAt }                       │
│   ├── pago.updated      { pedidoId, totalPagado, pendiente, estadoPedido }  │
│   └── impresion.updated { pedidoId, ok, total }                             │
│                                                                              │
│   Subscribers:                                                               │
│   ├── Cocina.jsx        → listens: pedido.updated                           │
│   ├── MozoMesas.jsx     → listens: mesa.updated, pedido.updated             │
│   ├── Pedidos.jsx       → listens: pedido.updated, pago.updated             │
│   └── DeliveryPedidos   → listens: pedido.updated                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## User Roles & Permissions

```
┌───────────┬───────────┬────────────────────┬───────────┬───────────┬───────────┐
│   Role    │ Dashboard │      Pedidos       │ Inventario│ Empleados │ Reportes  │
├───────────┼───────────┼────────────────────┼───────────┼───────────┼───────────┤
│   ADMIN   │     ✓     │ Todo               │     ✓     │     ✓     │     ✓     │
│   MOZO    │     -     │ Crear + ENTREGADO  │     -     │     -     │     -     │
│  COCINERO │     ✓     │ Cocina (estados)   │     -     │     -     │     -     │
│   CAJERO  │     ✓     │ Cobrar + estados   │     -     │     -     │     ✓     │
│  DELIVERY │     -     │ Solo delivery      │     -     │     -     │     -     │
└───────────┴───────────┴────────────────────┴───────────┴───────────┴───────────┘

Detalle de permisos MOZO:
- NO ve Dashboard
- Puede crear pedidos
- Solo puede cambiar estado a ENTREGADO (cuando entrega a mesa)
- NO puede registrar pagos
- NO puede cambiar a EN_PREPARACION ni LISTO

Detalle de permisos DELIVERY:
- Solo ve /delivery/pedidos
- Solo ve pedidos tipo DELIVERY
- Solo puede marcar como ENTREGADO
```

## Role-Based Redirects

```
Login exitoso:
  ├── ADMIN    ──▶ /dashboard
  ├── MOZO     ──▶ /mozo/mesas
  ├── COCINERO ──▶ /cocina
  ├── CAJERO   ──▶ /dashboard
  └── DELIVERY ──▶ /delivery/pedidos
```

## Key Files

| File | Responsibility | Read Before |
|------|----------------|-------------|
| `backend/prisma/schema.prisma` | Database models | Any DB changes |
| `backend/src/middlewares/auth.middleware.js` | JWT + Role verification | Auth changes |
| `backend/src/controllers/pedidos.controller.js` | Order logic + stock | Order flow changes |
| `backend/src/controllers/pagos.controller.js` | Payments + MP webhook | Payment changes |
| `backend/src/routes/publico.routes.js` | Public menu & ordering | Public API changes |
| `backend/src/services/email.service.js` | Order confirmation emails | Email changes |
| `backend/src/services/event-bus.js` | SSE pub/sub | Real-time changes |
| `backend/src/services/print.service.js` | Print queue management | Print changes |
| `frontend/src/context/AuthContext.jsx` | Global auth state | Auth UI changes |
| `frontend/src/App.jsx` | Route definitions | Adding pages |
| `frontend/src/services/eventos.js` | SSE client | Real-time UI changes |

## External Dependencies

| Service | Purpose | Config Location |
|---------|---------|-----------------|
| PostgreSQL | Primary database | `DATABASE_URL` in `.env` |
| Supabase | Production database (with pgbouncer) | `DATABASE_URL` + `DIRECT_URL` |
| MercadoPago | Payment processing | `MERCADOPAGO_ACCESS_TOKEN` |
| Nodemailer | Order confirmation emails | SMTP config in email.service.js |
| ESC/POS Printer | Thermal printing via bridge | Print Bridge config |

## Environment Variables

```bash
# Backend (.env)
PORT=3001
NODE_ENV=development

# Database (local)
DATABASE_URL="postgresql://user:pass@localhost:5432/gestioneo?schema=public"
DIRECT_URL="postgresql://user:pass@localhost:5432/gestioneo?schema=public"

# Database (Supabase production)
# DATABASE_URL="postgresql://postgres.xxx:PASS@aws.pooler.supabase.com:6543/postgres?pgbouncer=true"
# DIRECT_URL="postgresql://postgres.xxx:PASS@aws.pooler.supabase.com:5432/postgres"

# JWT
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="24h"

# Payments
MERCADOPAGO_ACCESS_TOKEN="TEST-xxx"
MERCADOPAGO_PUBLIC_KEY="TEST-xxx"
MERCADOPAGO_WEBHOOK_SECRET="xxx"  # For webhook signature verification

# CORS
FRONTEND_URL="http://localhost:5173"

# Bridge (bridge/.env)
BRIDGE_API_URL=https://tu-backend.railway.app/api
BRIDGE_TOKEN=tu_token_seguro
BRIDGE_ID=pc-caja-1
PRINTER_NAME=EPSON T2000 3I
PRINT_ADAPTER=spooler
POLL_INTERVAL_MS=2000
```

## Deployment

See `DEPLOY.md` for full deployment guide.

| Service | Provider | Cost |
|---------|----------|------|
| Database | Supabase | Free tier (sufficient for 100 orders/day) |
| Backend | Railway | ~$5/month |
| Frontend | Vercel | Free tier |
| Print Bridge | Local Windows PC | - |

## Notes for Agents

### Conventions
- Backend: CommonJS modules (`require`/`module.exports`)
- Frontend: ES Modules (`import`/`export`)
- API responses: `{ data }` or `{ error: { message } }`
- Dates: ISO 8601 format
- Money: Decimal with 2 places (Prisma `Decimal(10,2)`)
- Events: dot-notation names (`pedido.updated`, `mesa.updated`)

### Gotchas
- Stock deduction happens on `EN_PREPARACION`, not on order creation
- Mesa status changes automatically with order states
- Public routes (`/menu`, `/api/publico/*`) don't require auth
- Webhook endpoint `/api/pagos/webhook/mercadopago` is public
- **MOZO solo puede cambiar estado a ENTREGADO** (validado en backend)
- **MOZO no ve boton de pago** (ocultado en frontend)
- Tailwind v4 usa `@import "tailwindcss"` y `@theme` en index.css
- No hay tailwind.config.js - usa postcss.config.js con @tailwindcss/postcss
- Supabase requires `directUrl` in Prisma schema for migrations
- `ventasPorMozo` report handles null `usuarioId` (from public orders) as "Menú Público"
- PrintJob tiene unique constraint `[pedidoId, tipo, batchId]` para idempotencia
- Webhook de MP usa idempotencyKey para evitar duplicados

### Warnings
- `JWT_SECRET` must be changed in production
- Image uploads go to `backend/uploads/` - not persisted in containers (use S3/Cloudinary for prod)
- Printer integration requires local Windows bridge
- MercadoPago webhooks require public URL (use ngrok for local testing)
- MP webhook signature verification only enforced in production

### Testing
```bash
# Backend
cd backend
npm run dev                    # Start API on :3001

# Seed database
npx prisma migrate dev         # Run migrations
node prisma/seed-ewald.js      # Load Estación Ewald products
node prisma/seed-test-data.js  # Load test data

# Frontend
cd frontend
npm run dev                    # Start React on :5173

# Test users (Estación Ewald)
admin@ewald.com / 123456       # ADMIN - full access
mozo1@ewald.com / 123456       # MOZO - table service
mozo2@ewald.com / 123456       # MOZO - table service
cocina@ewald.com / 123456      # COCINERO - kitchen display
caja@ewald.com / 123456        # CAJERO - payments & reports
delivery@ewald.com / 123456    # DELIVERY - delivery orders
```

### Charts (Reportes.jsx)
The reports page uses Recharts with:
- **TopProductosRanking**: Medal-based ranking with progress bars
- **DonutChart**: For payment methods and order types
- **VentasPorMozoRanking**: Bar-based ranking for sales by waiter

---

# Funcionalidades Indispensables Propuestas

## 1. CRÍTICAS (Impacto Alto en Operación Diaria)

### 1.1 Arqueo de Caja / Cierre de Turno
**Estado actual**: No existe
**Problema**: No hay forma de cuadrar caja al final del día/turno
**Solución propuesta**:
```
- Crear modelo CierreCaja con: fecha, horaInicio, horaFin, fondoInicial,
  totalVentasEfectivo, totalVentasTarjeta, totalVentasMP, montoFinal,
  diferencia, observaciones, usuarioId
- Endpoint POST /api/cierres para crear cierre
- Vista de cierre con desglose por método de pago
- Reporte de cierres históricos
```

### 1.2 División de Cuenta / Pagos Parciales
**Estado actual**: Un pedido = un pago (o múltiples pagos sumados)
**Problema**: Clientes quieren pagar por separado en una mesa
**Solución propuesta**:
```
- Permitir dividir PedidoItems en sub-cuentas
- Cada sub-cuenta puede tener su propio método de pago
- UI para seleccionar items y asignar a persona/sub-cuenta
```

### 1.3 Reservas de Mesa
**Estado actual**: Estado RESERVADA existe pero no hay gestión
**Problema**: No se pueden gestionar reservas con fecha/hora
**Solución propuesta**:
```
- Crear modelo Reserva: mesaId, clienteNombre, clienteTelefono,
  fechaHora, cantidadPersonas, observaciones, estado (PENDIENTE/CONFIRMADA/CANCELADA)
- Calendario visual de reservas
- Notificación de reservas próximas
- Auto-liberar mesa si no llegan en X minutos
```

### 1.4 Modificadores de Producto (Extras/Sin)
**Estado actual**: Solo observaciones de texto libre
**Problema**: No hay control de precio para extras (queso extra, etc.)
**Solución propuesta**:
```
- Crear modelo Modificador: nombre, precio, activo
- Relación Producto-Modificador (qué modificadores aplican a qué productos)
- En PedidoItem agregar modificadores seleccionados
- El precio se ajusta automáticamente
```

## 2. IMPORTANTES (Mejoran Significativamente la Operación)

### 2.1 Gestión de Combos/Menús
**Estado actual**: Cada producto es independiente
**Problema**: No se pueden crear combos con descuento
**Solución propuesta**:
```
- Crear modelo Combo: nombre, precio, activo
- Relación Combo-Producto con cantidad de cada item
- Descuento automático al detectar combo en carrito
```

### 2.2 Descuentos y Promociones
**Estado actual**: Campo descuento manual en pedido
**Problema**: No hay gestión de promociones
**Solución propuesta**:
```
- Crear modelo Promocion: nombre, tipo (PORCENTAJE/MONTO_FIJO),
  valor, fechaInicio, fechaFin, diasSemana[], horaInicio, horaFin,
  aplicaA (PEDIDO/PRODUCTO/CATEGORIA), minimoCompra
- Cupones de descuento con código
- Aplicación automática o manual
```

### 2.3 Notificaciones Push/Sonoras
**Estado actual**: Solo polling + SSE visual
**Problema**: Cocina puede no ver pedido nuevo si no mira pantalla
**Solución propuesta**:
```
- Sonido de alerta en cocina cuando llega pedido nuevo
- Notificaciones del navegador (con permiso)
- Opcional: integración con Telegram/WhatsApp para alertas críticas
```

### 2.4 Propinas
**Estado actual**: No existe
**Problema**: No hay registro de propinas para reportes
**Solución propuesta**:
```
- Campo propina en Pago
- Opción de agregar propina en cobro
- Reporte de propinas por mozo
```

### 2.5 Control de Acceso por Turno
**Estado actual**: Cualquier usuario puede acceder siempre
**Problema**: No hay control de quién está trabajando
**Solución propuesta**:
```
- Vincular Usuario con Empleado
- Solo permitir acceso si tiene fichaje abierto
- Dashboard muestra solo métricas de su turno
```

## 3. ÚTILES (Mejoran Experiencia/Eficiencia)

### 3.1 Historial de Pedidos del Cliente
**Estado actual**: Solo datos básicos del cliente en pedido
**Problema**: No hay fidelización ni historial
**Solución propuesta**:
```
- Crear modelo Cliente: nombre, telefono, email, direccion, notas
- Vincular pedidos a cliente (opcional)
- Ver historial al crear pedido delivery
- "Repetir último pedido"
```

### 3.2 Productos Agotados Automáticos
**Estado actual**: Marcar disponible=false manualmente
**Problema**: Si se agota ingrediente, producto sigue disponible
**Solución propuesta**:
```
- Al descontar stock, verificar si algún ingrediente quedó en 0
- Marcar automáticamente productos afectados como no disponibles
- Notificar a admin
```

### 3.3 Tiempo Estimado de Preparación
**Estado actual**: No existe
**Problema**: Cliente/delivery no sabe cuánto esperar
**Solución propuesta**:
```
- Campo tiempoPreparacion en Producto (minutos)
- Calcular tiempo total del pedido
- Mostrar al cliente en menú público
- Alertar si pedido supera tiempo estimado
```

### 3.4 Múltiples Impresoras por Zona
**Estado actual**: Una cola de impresión general
**Problema**: Bebidas van a cocina en vez de barra
**Solución propuesta**:
```
- Campo zona en Producto (COCINA/BARRA/etc)
- PrintJob se crea por zona
- Bridge configura destino por zona
```

### 3.5 Anulación de Items con Motivo
**Estado actual**: Solo se pueden agregar items
**Problema**: Si cliente cancela un plato, no queda registro
**Solución propuesta**:
```
- Permitir anular PedidoItem con motivo
- Revertir stock si ya se descontó
- Reporte de anulaciones
```

## 4. DESEABLES (Nice to Have)

### 4.1 App Móvil para Mozo
- PWA o app nativa para tomar pedidos con tablet/celular

### 4.2 KDS (Kitchen Display System)
- Pantalla táctil dedicada para cocina
- Organización por prioridad/tiempo

### 4.3 Programa de Fidelización
- Puntos por compra
- Canje de puntos por descuentos

### 4.4 Integración con Delivery Apps
- PedidosYa, Rappi, etc.
- Sincronización de pedidos

### 4.5 Facturación Electrónica
- Integración con AFIP (Argentina)
- Emisión de facturas A/B/C

---

## Priorización Recomendada

| Prioridad | Funcionalidad | Complejidad | Impacto |
|-----------|---------------|-------------|---------|
| 1 | Arqueo de Caja | Media | Alto |
| 2 | Reservas de Mesa | Media | Alto |
| 3 | Modificadores de Producto | Media | Alto |
| 4 | Notificaciones Sonoras | Baja | Medio |
| 5 | División de Cuenta | Alta | Medio |
| 6 | Descuentos/Promociones | Alta | Medio |
| 7 | Historial de Cliente | Baja | Medio |
| 8 | Productos Agotados Auto | Baja | Medio |
| 9 | Propinas | Baja | Bajo |
| 10 | Tiempo Estimado | Baja | Bajo |
